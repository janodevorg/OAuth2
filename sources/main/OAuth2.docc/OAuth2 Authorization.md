# OAuth2 Authorization

Same authentication flow with real network calls. 

But first, what we saw in the previous sections was actually the _authorization flow with code grant_.

- An **authorization flow** is an interaction that authenticates (verifies identity), and based on 
that identity authorizes (grants access) to protected resources.

- A **grant** is something that the server agrees to give in response to a request. In OAuth2 there
are four grant types: authorization code, implicit, resource owner password credentials, and 
client credentials.

We’ll focus on the code grant flow because it is the most secure and preferred. The others are 
thought for scenarios where there are several levels of trust between the agents involved.

Here are the steps:

![Overview](oauth2-authorization.png)

Before we go further, let’s agree on some terms:

- **Protected resource**. Confidential information of an user. e.g. his Twitter timeline.
- **Resource server**. A server that hosts _protected resources_. e.g. Twitter.com.
- **User**. A human user with an account registered in a resource server. 
- **Client**. An application that the user is trying to access his protected resources 
  with. e.g. a Twitter client app on his phone.

## 1. Client requests an authorization code

The client redirects the user to the resource server. In a phone, the authentication can also 
happen launching a native app of the company that owns the resource server. That is, instead
redirecting to Twitter.com, the user could launch the Twitter native application (assuming it is
installed). In both cases the URL is almost the same, only the protocol is different. 

Here is an example that launches the Twitter.com website:
```
https://twitter.com/authorize
?response_type=code
&client_id=CLIENT_ID
&redirect_uri=REDIRECT_URI
&scope=email
&state=1234zyx
&code_challenge=XXXXXXX
&code_challenge_method=S256
```
where

| Parameter | Meaning |
|--|--|
| `response_type`         | `code` means we request an authorization code. |
| `client_id`             | Identifier granted by the server during client registration. |
| `redirect_uri`          | The URI to return the user to when authorization is successful. |
| `scope`                 | `email` is the protected resource we request access to. |
| `state`                 | A random string generated by the client. |
| `code_challenge`        | Base64-encoded version of the sha256 hash of a _code verifier string_, which is a random string that the app stores locally. |
| `code_challenge_method` | `S256` indicates sha256 as the hashing method. |

The website (or app) of the resource server prompts the user to grant access to the client 
application. 

## 2. Return authorization code

After the user agrees to authorize the client app at the resource server, the server 
sends a custom URL similar to this:

```
twitClient://authorize
?code=AUTHORIZATION_CODE
&state=1234zyx
```

This custom URL launches the client application. The client app checks that the state matches the 
one used in his original request.

## 3. Trade authorization code for access token

The client app trades the authorization code for an access token. This trade is called _token 
exchange_, and it’s a POST request similar to this:

```
POST https://api.authorization-server.com/token
?grant_type=authorization_code
&code=AUTH_CODE_HERE
&redirect_uri=REDIRECT_URI
&client_id=CLIENT_ID
&code_verifier=VERIFIER_STRING
```

| Parameter | Description |
|--|--|
| `grant_type`    | The grant type authorization_code. |
| `code`          | The authorization code received in the previous call. |
| `redirect_uri`  | It must be identical to the redirect_uri you sent in the authentication call. |
| `client_id`     | The ID received during registration. |
| `code_verifier` | The plaintext used to create the code_challenge (not the code challenge itself) in the authorization call. |

If the server supports PKE (every modern server does) it will hash the value of the `code_verifier` 
and confirm that the hashed value matches the value of the `code_challenge` sent in the first 
request.

## 4. Return an access token

This is a string sent to the client in the response of the POST request, usually as a JSON 
document. The format is arbitrary.

```
{
  "access_token":"dKrouXGDK9xrcNUcUTbZ",
  "expires_in":3600,
  "refresh_token":"xM3twXjo2obKo4EkuNtF"
}
```

In this example, the response includes

- The access token itself.
- An expiration time for the access token.
- A refresh token. 

The refresh token can be sent to an endpoint to obtain an access token with a renewed expiration 
time. All this is optional. The server may issue a permanent token instead, or force you to repeat
the authorization flow.

## 5. Access protected resources

At this point you can access protected resources at the resource server. Each call should have a 
header `Auhorization: Bearer ACCESS_TOKEN`. For instance:

```
curl -H "Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia" \
https://api.authorization-server.com/1/me
```

A **bearer token** is a type of access token whereby simple possession of the token values 
provides access to protected resources. No additional information, such as a cryptographic key, 
is needed to make API calls.

The bearer could also be set as a query parameter or a Form-encoded body parameter, but that's 
rare. Header is preferred because is not usually logged or cached.

## RFC6749

If you fancy reading this again with the RFC on the side, here are the relevant sections for each 
step.

| Step | RFC section |
|--|--|
| 1. Client requests an authorization code | [4.1.1 Authorization Request](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1) |
| 2. Server returns an authorization code | [4.1.2. Authorization Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2) |
| -- | [4.1.2.1. Error Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2.1) |
| 3. Client trades authorization code for access token | [4.1.3. Access Token Request](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.3) |
| 4. Server returns access token | [4.1.4. Access Token Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.4) |
| 5. Client access protected resources | -- |
